<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map Path</title>
  <link rel="stylesheet" type="text/css" href="../web_test/main.css">
  <link rel="stylesheet" type="text/css" href="./map.css">
  <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey="></script>
  <script>
    
    // 지도 생성
    var map;
    function initMap(){
      map = new Tmapv2.Map("map_div", {
				center : new Tmapv2.LatLng(37.88728485257855, 127.73813767661932),
				zoom : 15,
				zoomControl: false,
				scrollwheel: true
			});
    }

    // 여행지 리스트
    //var trip_response;
    $.ajax({
      url : "map_data.json",
      type : "GET",
      dataType : "json",
      success: function(response){
        tripList(response.trip_data);
        
      },
      error: function(error){
        alert("여행지 리스트를 불러오지 못 했습니다.");
      }
    });

    function tripList(trip_data){
      for(var i=0; i<trip_data.length; i++){
        var data = trip_data[i];
        $("#list").append("<hr><div class='container_list_el'>" +
                            "<img src='" + data.image + "'>" +
                            "<div class='container_list_el_name'>" +
                              "<span class='container_list_el_name_check'>" +
                                "<input type='checkbox' id='ckbox" + i + "' name='"+ data.spot +"' value='"+ data.y+ "," + data.x +"' onclick='setMarker("+ i +")'>" +
                              "</span>" +
                              "<span>" + data.spot + "</span>" +
                              "<p>" + data.description + "</p>" +
                            "</div>" +
                          "</div>");
      }
    }

    // 마커 생성 (최대 5개)
    var markers = new Array(5);
    function setMarker(ckbox_id_number){
      var check = $("input:checkbox[id='ckbox" + ckbox_id_number + "']").is(":checked");
      //var data = trip_response[ckbox_id_number];
      var point = $("input:checkbox[id='ckbox" + ckbox_id_number + "']").val();
      var title = $("input:checkbox[id='ckbox" + ckbox_id_number + "']").attr('name');
      var x = "", y = "";
      var jum = point.indexOf(',');
      for(var i=0; i<point.length; i++){
        if(i < jum){
          y += point[i];
        }
        else if(i > jum){
          x += point[i];
        }
      }

      // checkBox == true
      if(check){
        // 마커가 최대로 생성될 경우 처리
        if(markers[markers.length-1] != null){
          alert("여행지는 최대 "+ markers.length +"개까지 선택 가능합니다.");
          $("input:checkbox[id='ckbox" + ckbox_id_number + "']").prop("checked", false);
          return;
        } 

        // 마커 생성
        var marker = new Tmapv2.Marker({
					position : new Tmapv2.LatLng(y, x),
					icon : "http://tmapapi.sktelecom.com/upload/tmap/marker/pin_b_m_p.png",
					map : map,
					title : title
				});
        for(var i=0; i<markers.length; i++){
          if(markers[i] == null){
            markers[i] = marker;
            break;
          }
        }
      }
      // checkBox == false
      else{
        // 삭제할 마커 찾기
        for(var i=0; i<markers.length; i++){
          // 삭제할 마커를 찾은 경우
          if(markers[i]._marker_data.options.title == title){
            markers[i].setMap(null);
            // 마지막 마커를 삭제하는 경우
            if(i == markers.length-1){
              markers[i] = null;
            }
            // 처음이나 중간 마커를 삭제하는 경우
            else{
              for(var j=i; j<markers.length; j++){
                if(markers[j+1] != null){
                  markers[j] = markers[j+1];
                  markers[j+1] = null;
                }
              }
              break;
            }
          }
        }
      }
    }
    

    // 경로탐색
    //var path_response;
    var headers = {};
    headers["appKey"]= "";
    function path(){
      var cnt = 0;
      var data = markers;
      for(var i=0; i<data.length; i++){
        if(data[i] != null){
          cnt++;
        }
      }
      var startX = data[0]._marker_data.options.position._lng;
      var startY = data[0]._marker_data.options.position._lat;
      var endX = data[cnt-1]._marker_data.options.position._lng;
      var endY = data[cnt-1]._marker_data.options.position._lat;
      var passList = "";
      for(var i=1; i<cnt-1; i++){
				if(passList != "")
					passList += "_"; 	
				passList += data[i]._marker_data.options.position._lng + "," + data[i]._marker_data.options.position._lat;
			}
      $.ajax({
        method: "POST", 
        headers: headers, 
        url: "https://apis.openapi.sk.com/tmap/routes?version=1&format=json",
        async: false,
        data: {
          startX: startX,
          startY: startY,
          endX: endX,
          endY: endY,
          passList: passList,
          reqCoordType : "WGS84GEO",
					resCoordType : "WGS84GEO",
          searchOption : "0",
					trafficInfo : "Y" // 교통정보 표시
        },
        success: function(response){
          //path_response = response;
          drawPath(response);
        },
        error: function(error){
          alert("여행 경로를 불러오지 못 했습니다.");
        }
      });
    }

    
    // 경로 그리기
    function drawPath(data){
      var new_polyLine = [];
		  var pointArray = [];
      // 지도위에 선은 다 지우기
      var routeData = data;
      // var resultStr = "";//
      // var distance = 0;//
      // var idx = 1;//
      var newData = [];
      var equalData = [];
      var pointId1 = "-1234567";
      var ar_line = [];

      for (var i = 0; i < data.features.length; i++) {
        var feature = data.features[i];
        //배열에 경로 좌표 저장
        if(feature.geometry.type == "LineString"){
          ar_line = [];
          for (var j = 0; j < feature.geometry.coordinates.length; j++) {
            var startPt = new Tmapv2.LatLng(feature.geometry.coordinates[j][1],feature.geometry.coordinates[j][0]);
            ar_line.push(startPt);
            pointArray.push(feature.geometry.coordinates[j]);
          }
          // 라인그리기
          var polyline = new Tmapv2.Polyline({
            path: ar_line,
            strokeColor: "#0000ff", 
            strokeWeight: 6,
            strokeStyle: "solid",
            outline: true,
            map: map
          });
          new_polyLine.push(polyline);
        }
        // var pointId2 = feature.properties.viaPointId;
        // if (pointId1 != pointId2) {
        //   equalData = [];
        //   equalData.push(feature);
        //   newData.push(equalData);
        //   pointId1 = pointId2;
        // }
        // else {
        //   equalData.push(feature);
        // }
      }
    }
  </script>
</head>
<body onload="initMap()">
  <header>
    <div class="wrapper">
      <h1> LOGO </h1>
      <!--<img src="LOGO.png" width="5%", height="5%"> -->
      <ul class="menu">
        <li><a href="#">이달의 추천 여행지</a></li>
        <li><a href="#">나의 루트</a></li>
      </ul>
    </div>
  </header>
  <section>
    <div class="container">
      <div class="container_title">
        <span><span id="container_area">(선택한 여행지)</span>의 추천 관광지를 찾아봤어요</span>
        <input type="button" id="draw_path" value="경로 안내" onclick="path()">
      </div>
      <div class="container_box">
        <!-- 여행지 list -->
        <div class="container_list" id="list"></div>
        <!-- 지도 -->
        <div class="container_map">
          <div id="map_div"></div>
        </div>
      </div>
    </div>
  </section>
  <footer>
    <div class="footer">
        <div>
        <p>copyright</p>
        </div>
    </div>
</footer>
</body>
</html>